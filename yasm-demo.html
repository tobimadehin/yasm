<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YASM v2 Demo - "useState but cached"</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom styles for the demo */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        /* Ensure debug monitor is properly positioned */
        .fixed {
            position: fixed;
        }

        .z-50 {
            z-index: 50;
        }

        .z-60 {
            z-index: 60;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // YASM v2 - Simple cache implementation for demo
        const cache = new Map();

        function get(key) {
            const entry = cache.get(key);
            if (!entry) return undefined;

            if (Date.now() - entry.timestamp > entry.ttl) {
                cache.delete(key);
                return undefined;
            }

            return entry.data;
        }

        function set(key, data, ttl) {
            cache.set(key, {
                data,
                timestamp: Date.now(),
                ttl,
            });
        }

        // YASM v2: The only hook you need - "useState but cached"
        function useCached(key, fetcher, ttl = 300000) {
            const [data, setData] = useState(() => get(key));
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const mountedRef = useRef(true);

            useEffect(() => {
                return () => {
                    mountedRef.current = false;
                };
            }, []);

            const fetchData = async () => {
                setLoading(true);
                setError(null);

                try {
                    const result = await fetcher();

                    if (mountedRef.current) {
                        set(key, result, ttl);
                        setData(result);
                        setLoading(false);
                    }
                } catch (err) {
                    if (mountedRef.current) {
                        setError(err);
                        setLoading(false);
                    }
                }
            };

            useEffect(() => {
                const cachedData = get(key);

                if (cachedData !== undefined) {
                    setData(cachedData);
                    return;
                }

                fetchData();
            }, [key]);

            const refetch = async () => {
                await fetchData();
            };

            return { data, loading, error, refetch };
        }

        // Demo Components
        function UserProfile({ userId }) {
            const { data: user, loading, error } = useCached(
                `user-${userId}`,
                async () => {
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return {
                        id: userId,
                        name: `User ${userId}`,
                        email: `user${userId}@example.com`,
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${userId}`
                    };
                },
                10000 // 10 second cache
            );

            if (loading) return <div className="animate-pulse bg-gray-200 h-20 rounded"></div>;
            if (error) return <div className="text-red-500">Error: {error.message}</div>;

            return (
                <div className="bg-white p-4 rounded-lg shadow border">
                    <div className="flex items-center space-x-3">
                        <img src={user.avatar} alt={user.name} className="w-12 h-12 rounded-full" />
                        <div>
                            <h3 className="font-semibold">{user.name}</h3>
                            <p className="text-gray-600 text-sm">{user.email}</p>
                        </div>
                    </div>
                </div>
            );
        }

        function Dashboard() {
            const { data, loading, refetch } = useCached(
                'dashboard-stats',
                async () => {
                    await new Promise(resolve => setTimeout(resolve, 800));
                    return {
                        users: Math.floor(Math.random() * 1000) + 500,
                        revenue: Math.floor(Math.random() * 50000) + 10000,
                        conversion: (Math.random() * 5 + 2).toFixed(1)
                    };
                },
                5000 // 5 second cache
            );

            return (
                <div className="bg-white p-6 rounded-lg shadow border">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">ðŸ“Š Dashboard</h2>
                        <button
                            onClick={refetch}
                            className="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
                        >
                            Refresh
                        </button>
                    </div>

                    {loading && !data ? (
                        <div className="grid grid-cols-3 gap-4">
                            {[1, 2, 3].map(i => (
                                <div key={i} className="animate-pulse bg-gray-200 h-16 rounded"></div>
                            ))}
                        </div>
                    ) : (
                        <div className="grid grid-cols-3 gap-4">
                            <div className="text-center">
                                <div className="text-2xl font-bold text-blue-600">{data?.users}</div>
                                <div className="text-sm text-gray-600">Users</div>
                            </div>
                            <div className="text-center">
                                <div className="text-2xl font-bold text-green-600">${data?.revenue?.toLocaleString()}</div>
                                <div className="text-sm text-gray-600">Revenue</div>
                            </div>
                            <div className="text-center">
                                <div className="text-2xl font-bold text-purple-600">{data?.conversion}%</div>
                                <div className="text-sm text-gray-600">Conversion</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function App() {
            const [selectedUser, setSelectedUser] = useState(1);

            return (
                <div className="min-h-screen bg-gray-50 p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-900 mb-2">
                                YASM v2 Demo
                            </h1>
                            <p className="text-xl text-gray-600 mb-4">
                                "useState but cached" - The simplest React data fetching library
                            </p>
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                                <code className="text-sm">
                                    {`const { data, loading } = useCached('users', fetchUsers);`}
                                </code>
                            </div>
                        </div>

                        <div className="space-y-6">
                            <Dashboard />

                            <div className="bg-white p-6 rounded-lg shadow border">
                                <h2 className="text-xl font-bold mb-4">ðŸ‘¤ User Profiles (Cached)</h2>
                                <div className="flex space-x-2 mb-4">
                                    {[1, 2, 3, 4].map(id => (
                                        <button
                                            key={id}
                                            onClick={() => setSelectedUser(id)}
                                            className={`px-3 py-1 rounded text-sm ${selectedUser === id
                                                ? 'bg-blue-500 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                        >
                                            User {id}
                                        </button>
                                    ))}
                                </div>
                                <UserProfile userId={selectedUser} />
                            </div>

                            <div className="bg-gray-100 p-4 rounded-lg text-sm text-gray-600">
                                <p><strong>Try this:</strong> Switch between users quickly - notice how cached data loads instantly!</p>
                                <p><strong>Bundle size:</strong> Only 1.1KB gzipped (vs 20KB+ for other solutions)</p>
                                <p><strong>API:</strong> Just 3 exports - useCached, preload, clear</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>